#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# OpenAPI Pre-commit Validation Hook
echo "üîç Running OpenAPI pre-commit validation..."

# Get list of staged OpenAPI files
STAGED_OPENAPI=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(openapi\.yml|openapi\.yaml)$' || true)

if [ -n "$STAGED_OPENAPI" ]; then
    echo "üìã Validating OpenAPI specifications..."
    
    # Validate each staged OpenAPI file
    for file in $STAGED_OPENAPI; do
        echo "Checking: $file"
        
        # Run Redocly validation
        if npx @redocly/cli lint "$file" --config ../.redocly.yaml; then
            echo "‚úÖ $file validated successfully"
        else
            echo "‚ùå $file validation failed"
            echo "Please fix the OpenAPI specification before committing."
            exit 1
        fi
    done
    
    echo "‚úÖ All OpenAPI specifications validated successfully!"
fi

# Run standard lint-staged
npx lint-staged