# GitLab CI/CD Pipeline for OpenAPI AI Agents Standard
# API-first pipeline with TDD approach

stages:
  - validate
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Validate API OpenAPI Specification
validate:api-spec:
  image: node:18-alpine
  stage: validate
  before_script:
    - apk add --no-cache git
  script:
    - echo "üîç Validating API OpenAPI specification..."
    - cd validators && npm install
    - node openapi-validator.js ../api/openapi.json
    - echo "‚úÖ API specification validation completed"
  only:
    - main
    - merge_requests

# Validate Example Specifications
validate:examples:
  image: node:18-alpine
  stage: validate
  before_script:
    - apk add --no-cache git
  script:
    - echo "üîç Validating example specifications..."
    - cd validators && npm install
    - node openapi-validator.js ../examples/basic/hello-agent.yaml
    - echo "‚úÖ Example validation completed"
  only:
    - main
    - merge_requests

# API Unit Tests (TDD)
test:api:unit:
  image: node:18-alpine
  stage: test
  before_script:
    - apk add --no-cache git curl
  script:
    - echo "üß™ Running API unit tests (TDD)..."
    - cd api && npm install
    - npm test -- --coverage --testResultsProcessor=jest-junit
    - echo "‚úÖ API unit tests completed"
  coverage: '/Lines\s*:\s*([0-9.]+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: api/coverage/cobertura-coverage.xml
      junit: api/junit.xml
    paths:
      - api/coverage/
    expire_in: 1 week
  only:
    - main
    - merge_requests

# Validator Unit Tests
test:validators:unit:
  image: node:18-alpine
  stage: test
  before_script:
    - apk add --no-cache git
  script:
    - echo "üîç Running validator unit tests..."
    - cd validators && npm install
    - npm test -- --coverage
    - echo "‚úÖ Validator tests completed"
  coverage: '/Lines\s*:\s*([0-9.]+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: validators/coverage/cobertura-coverage.xml
    paths:
      - validators/coverage/
    expire_in: 1 week
  only:
    - main
    - merge_requests

# API Integration Tests
test:api:integration:
  image: docker:24-dind
  stage: test
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache curl jq nodejs npm
  script:
    - echo "üîó Running API integration tests..."
    - cd api
    - docker build -t validation-api-test .
    - docker run -d -p 3000:3000 --name api-test -e API_KEYS=test-key validation-api-test
    - sleep 15
    - echo "Testing health endpoint..."
    - curl -f http://localhost:3000/api/v1/health
    - echo "Testing frameworks endpoint..."
    - curl -f http://localhost:3000/api/v1/frameworks
    - echo "Testing validation endpoint..."
    - |
      curl -f -X POST http://localhost:3000/api/v1/validate/openapi \
        -H "Content-Type: application/json" \
        -H "X-API-Key: test-key" \
        -d '{"specification": {"openapi": "3.1.0", "info": {"title": "Test", "version": "1.0.0", "description": "Test"}, "paths": {}}}'
    - echo "‚úÖ Integration tests completed"
  after_script:
    - docker stop api-test || true
    - docker rm api-test || true
  only:
    - main
    - merge_requests

# Build Docker Image
build:docker:
  image: docker:24-dind
  stage: build
  services:
    - docker:24-dind
  script:
    - echo "üê≥ Building validation API Docker image..."
    - cd api
    - docker build -t $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/validation-api:latest
    - echo "üì§ Pushing to GitLab Container Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/validation-api:latest
    - echo "‚úÖ Docker build and push completed"
  only:
    - main
    - tags

# Deploy to Staging
deploy:staging:
  image: alpine:latest
  stage: deploy
  environment:
    name: staging
    url: https://api-staging.openapi-ai-agents.org
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üöÄ Deploying validation API to staging..."
    - echo "Container image: $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA"
    - echo "Environment: staging"
    - echo "‚úÖ Staging deployment completed"
  only:
    - main
  when: manual

# Deploy to Production
deploy:production:
  image: alpine:latest
  stage: deploy
  environment:
    name: production
    url: https://api.openapi-ai-agents.org
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üöÄ Deploying validation API to production..."
    - echo "Container image: $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA"
    - echo "Environment: production"
    - echo "‚úÖ Production deployment completed"
  only:
    - tags
  when: manual

# Generate API Documentation
pages:
  image: node:18-alpine
  stage: deploy
  script:
    - echo "üìñ Generating API documentation..."
    - mkdir public
    - cp api/openapi.json public/
    - echo '<!DOCTYPE html><html><head><title>OpenAPI AI Agents Validation API</title><link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@3.25.0/swagger-ui.css" /></head><body><div id="swagger-ui"></div><script src="https://unpkg.com/swagger-ui-dist@3.25.0/swagger-ui-bundle.js"></script><script>SwaggerUIBundle({url: "./openapi.json", dom_id: "#swagger-ui", presets: [SwaggerUIBundle.presets.apis, SwaggerUIBundle.presets.standalone]})</script></body></html>' > public/index.html
    - echo "‚úÖ Documentation generated"
  artifacts:
    paths:
      - public
  only:
    - main