---
# GitLab CI/CD Pipeline for OSSA
# Node.js TypeScript project with comprehensive testing

stages:
  - build
  - test
  - lint
  - typecheck
  - format-check

variables:
  NODE_VERSION: "20"
  DOCKER_BUILDKIT: "1"
  GIT_STRATEGY: fetch
  GIT_DEPTH: 1

# Build job
build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - merge_requests
    - development
    - main

# Test job
test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm test -- --coverage --coverageReporters=text --coverageReporters=lcov
  coverage: '/All files\s+\|\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - development
    - main

# Lint job
lint:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run lint
  allow_failure: true
  only:
    - merge_requests
    - development
    - main

# Typecheck job
typecheck:
  stage: typecheck
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run typecheck
  only:
    - merge_requests
    - development
    - main

# Format check job
format-check:
  stage: format-check
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run format:check
  only:
    - merge_requests
    - development
    - main
