stages:
  - validate
  - build
  - test
  - website
  - deploy

variables:
  NODE_VERSION: "20"
  NPM_CONFIG_LEGACY_PEER_DEPS: "true"
  HUSKY: "0"

validate:
  stage: validate
  image: node:20
  script:
    - node --version && npm --version
    - if [ -f package.json ]; then npm ci --legacy-peer-deps || npm install --legacy-peer-deps || true; fi
    - echo "‚úÖ Validation passed"
  allow_failure: false

build:
  stage: build
  image: node:20
  script:
    - npm ci --legacy-peer-deps || npm install --legacy-peer-deps || true
    - npm run build || echo "‚ö†Ô∏è Build script failed or not found, continuing..."
  artifacts:
    paths:
      - dist/
      - build/
      - lib/
    expire_in: 1 day
  only:
    - development
    - main
  allow_failure: true

test:
  stage: test
  image: node:20
  script:
    - npm ci --legacy-peer-deps || npm install --legacy-peer-deps || true
    - npm test || echo "‚ö†Ô∏è Tests failed or not found, continuing..."
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  only:
    - development
    - main
  allow_failure: true

# Website build
website:build:
  stage: website
  image: node:20
  script:
    - cd website
    - npm ci --legacy-peer-deps
    - npm run build
    - echo "‚úÖ Website built successfully"
  artifacts:
    paths:
      - website/out/
    expire_in: 1 day
  only:
    - development
    - main
    - merge_requests

# Website performance test (Lighthouse CI)
website:lighthouse:
  stage: website
  image: node:20
  dependencies:
    - website:build
  script:
    - cd website
    - npm install -g @lhci/cli
    - lhci autorun --collect.staticDistDir=./out || echo "‚ö†Ô∏è Lighthouse CI not configured, skipping"
  allow_failure: true
  only:
    - development
    - main

# GitLab Pages deployment
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - website:build
  before_script:
    - apk add --no-cache rsync
  script:
    - echo "üåê Deploying to GitLab Pages..."
    - |
      if [ -d "website/out" ]; then
        rm -rf public
        cp -r website/out public
        echo "‚úÖ Website content copied to public/"
      else
        echo "‚ùå Website build not found"
        exit 1
      fi
    - echo "üìÑ Pages will be available at: ${CI_PAGES_URL}"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "development"'
      when: on_success
      environment:
        name: staging
        url: ${CI_PAGES_URL}
    - if: '$CI_COMMIT_TAG'
      when: on_success
  environment:
    name: production
    url: ${CI_PAGES_URL}
