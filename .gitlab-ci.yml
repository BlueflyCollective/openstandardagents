# GitLab CI/CD Pipeline for OpenAPI AI Agents Standard
# Simplified pipeline focusing on working validation tests
# Updated: 2025-08-25 - Fixed NPM package installation issues

stages:
  - validate
  - test
  - security

# Simple validation job
validate:openapi:
  image: node:18-alpine
  stage: validate
  before_script:
    - apk add --no-cache git
  script:
    - echo "ğŸ” Validating OpenAPI specification..."
    - cd validators && npm install
    - node openapi-validator.js ../examples/basic/hello-agent.yaml
    - echo "âœ… OpenAPI validation completed"
  only:
    - main
    - merge_requests

# Unit tests for validators
test:validators:
  image: node:18-alpine
  stage: test
  before_script:
    - apk add --no-cache git
  script:
    - echo "ğŸ§ª Running validator unit tests..."
    - cd validators && npm install
    - npm test
    - echo "âœ… Validator tests completed"
  coverage: '/Lines\s*:\s*([0-9.]+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: validators/coverage/cobertura-coverage.xml
    paths:
      - validators/coverage/
    expire_in: 1 week
  only:
    - main
    - merge_requests

# Token estimation test
test:token-estimation:
  image: node:18-alpine
  stage: test
  before_script:
    - apk add --no-cache git
  script:
    - echo "ğŸ’° Testing token estimation..."
    - cd validators && npm install
    - node token-estimator.js ../examples/basic/hello-agent.yaml --model gpt-4-turbo --requests 100
    - echo "âœ… Token estimation completed"
  only:
    - main
    - merge_requests

# Basic security scan
security:npm-audit:
  image: node:18-alpine
  stage: security
  before_script:
    - apk add --no-cache git
  script:
    - echo "ğŸ”’ Running npm security audit..."
    - cd validators && npm install
    - npm audit --audit-level=moderate || echo "Some vulnerabilities found but not blocking"
    - echo "âœ… Security audit completed"
  allow_failure: true
  only:
    - main
    - merge_requests